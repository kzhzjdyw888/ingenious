<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>我的收藏</title>
    <style>
        .custom-card {
            width: 100%;
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* 从起点开始对齐 */
        }

        .avatar {
            width: 60px;
            height: 60px;
            line-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #76dbb4;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            border-radius: 4px;
            margin-right: 10px;
            /* 为头像和标题之间添加间距 */
        }

        .header-info {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 70px);
            /* 限制标题的最大宽度，为头像留出空间 */
        }

        .title {
            white-space: nowrap;
            /* 防止标题换行 */
            overflow: hidden;
            /* 隐藏溢出部分 */
            text-overflow: ellipsis;
            /* 用省略号表示溢出部分 */
            margin-bottom: 0;
        }

        .card-footer {
            margin-top: auto;
            text-align: right;
        }

        .button {
            padding: 5px 10px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
        }

        .button:hover {
            background-color: #e5e5e5;
        }

        .remove-btn {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #ab0c0c;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>

<body class="pear-container">
<div class="layui-row" style="margin-bottom: 20px;">
    <div class="layui-card-body">
        <button type="submit" class="pear-btn pear-btn-primary pear-btn-md edit-btn" lay-submit="" lay-on="favoriteEdit">
            <i class="layui-icon layui-icon-edit"></i>
            编辑
        </button>
        <button type="submit" class="pear-btn pear-btn-primary pear-btn-md finish-btn" lay-submit="" style="display: none;" lay-on="favoriteFinish">
            <i class="layui-icon layui-icon-edit"></i>
            完成
        </button>
        <button type="button" class="pear-btn pear-btn-md add-btn" lay-on="favoriteAdd">

            <i class="layui-icon layui-icon-add-circle-fine"></i>
            添加
        </button>
    </div>
</div>
<!-- 卡片渲染 -->
<div class="layui-row" style="margin-bottom: 20px;" id="collection-list"></div>

<script src="../../../config/common.js"></script>
<script src="../../../config/permission.js"></script>
<script src="../../../config/config.js"></script>
<script>

    const PRIMARY_KEY = "id";
    //当前模块的基础目录
    const MODULE_PATH = "view/wf/favorite/";
    //Api相关接口
    const LIST_API = config.api_url + "/adminapi/wf/process_define/favorite/page";
    const READ_API = config.api_url + "/adminapi/wf/process_define/favorite/detail";
    const SAVE_API = config.api_url + "/adminapi/wf/process_define/favorite/save";
    const DELETE_API = config.api_url + "/adminapi/wf/process_define/favorite/delete";
    const REMOVE_API = config.api_url + "/adminapi/wf/process_define/favorite/remove";

    layui.use(['jquery', 'layer', 'util', 'common'], function () {
        let $ = layui.jquery;
        let layer = layui.layer;
        let util = layui.util;
        let common = layui.common;
        let deleteIds = [];

        //视图渲染
        function renderCard() {
            $.ajax({
                url: LIST_API,
                type: 'get',
                dataType: 'json',
                data: {page: 0, limit: 0},
                success: function (ret) {
                    if (ret.status == 200) {
                        let data = ret.data['list'] != undefined ? ret.data['list'] : [];
                        template(data)
                    }
                }
            });
        }

        //模板渲染
        function template(data) {
            // 遍历数据生成列表项
            const container = document.getElementById('collection-list');
            container.innerHTML = '';
            $.each(data, function (index, item) {
                container.innerHTML += `
                    <div class="layui-col-md3 layui-card-body" data-item='${JSON.stringify(item)}'>
                        <div class="custom-card">
                            <span class="remove-btn" style="display: none;"  lay-on="deleteCard">
                                <i class="layui-icon layui-icon-reduce-circle"></i>
                            </span>
                            <div class="card-header">
                                <div class="avatar">
                                <span>${item.display_name ? item.display_name.substring(0, 2) : ''}</span>
                                </div>
                                <div class="header-info">
                                    <h4>${'v' + item.version ? item.version : '1.0'}</h4>
                                    <h3 class="title">${item.display_name ? item.display_name : ''}</h3>
                                </div>
                            </div>
                            <div class="card-footer">
                                <span style="cursor: pointer;">
                                    <i class="layui-icon">&#xe642;</i>
                                </span>
                                &nbsp;&nbsp;
                                <button class="layui-btn-xs" data-item='${JSON.stringify(item)}'
                                    style="border: solid 1px #edd8ac;color: #d1ae66;padding: 1px 10px 2px 10px;cursor: pointer;" lay-on="launchApplication" >发起申请</button>
                            </div>
                        </div>
                    </div>`;
            });

        }


        //编辑模式
        function edit(self) {
            $(self).hide(); // 隐藏编辑按钮
            $('.remove-btn').show(); // 显示所有移除按钮
            $('.finish-btn').show(); // 显示所有移除按钮
            $('.add-btn').hide();
        }

        function add(self) {
            layer.open({
                type: 2,
                title: '选择流程',
                anim: 0,
                maxmin: true,
                shade: 0.1,
                shadeClose: true,
                area: [common.isModile() ? '100%' : '800px', common.isModile() ? '100%' : '450px'],
                content: 'view/wf/favorite/add.html?operation=add',
                success: function (layero, index) {

                }, end: function (layero, index) {
                    renderCard();
                }
            })
        }

        //删除card 数据
        function deleteCard(self) {
            let cardBody = self.parentNode.parentNode;
            let itemData = JSON.parse(cardBody.getAttribute('data-item'));
            cardBody.parentNode.removeChild(cardBody);
            deleteIds.push(itemData.id);
        }

        //点击完成提交操作
        function finish(self) {
            $(self).hide();
            $('.remove-btn').hide();
            $('.edit-btn').show();
            $('.add-btn').show();
            if (deleteIds.length == 0) {
                return false;
            }
            $.ajax({
                url: REMOVE_API,
                type: 'POST',
                dataType: 'json',
                data: {
                    data: deleteIds
                },
                success: function (ret) {
                    renderCard();
                }
            });
        }

        function launchApplication(self) {
            let item = JSON.parse(self.getAttribute('data-item'));
            layer.open({
                type: 2,
                offset: 'r',
                area: ['70%', '100%'],
                title: false,
                shade: 0.1,
                closeBtn: 0,
                shadeClose: true,
                anim: -1,
                skin: 'layer-anim-right',
                move: true,
                content: 'view/wf/common/launchProcess.html?operation=edit&' + PRIMARY_KEY + '=' + item['process_define_id'],
                success: function (layero, index) {
                }, end: function (layero, index) {

                }
            })
        }

        //事件
        util.on({
            launchApplication: function () {
                launchApplication(this)
            },
            deleteCard: function () {
                deleteCard(this)
            },
            favoriteEdit: function () {
                edit(this)
            },
            favoriteFinish: function () {
                finish(this)
            },
            favoriteAdd: function () {
                add(this)
            }
        });

        renderCard();
    })
</script>
</body>

</html>
