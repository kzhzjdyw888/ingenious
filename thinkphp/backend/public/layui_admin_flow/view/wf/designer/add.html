<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加流程设计</title>
    <link rel="stylesheet" href="../../../component/pear/css/pear.css" />
	<link rel="stylesheet" href="../../../admin/css/reset.css" />
</head>
<body>

<form class="layui-form" action="" lay-filter="designer-add-form">

    <div class="mainBox">
        <div class="main-container mr-5">
            <div class="layui-form-item">
                <label class="layui-form-label required">流程类型</label>
                <div class="layui-input-block">
                    <ul id="designer-add-tree" class="dtree" data-id="0"></ul>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">显示名称</label>
                <div class="layui-input-block">
                    <input type="text" name="display_name" required lay-verify="required" autocomplete="off" class="layui-input" placeholder="">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">唯一编码</label>
                <div class="layui-input-block">
                    <input type="text" name="name" required lay-verify="required" autocomplete="off" class="layui-input" placeholder="">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">模型描述</label>
                <div class="layui-input-block">
                    <input type="text" name="description" lay-verify="" autocomplete="off" class="layui-input" placeholder="">
                </div>
            </div>


            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <textarea placeholder="" class="layui-textarea" name="remark"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom">
        <div class="button-container">
            <button type="submit" class="pear-btn pear-btn-primary pear-btn-md" lay-submit=""
                    lay-filter="designer-add-save">
                保存
            </button>
            <button type="reset" class="pear-btn pear-btn-md">
                重置
            </button>
        </div>
    </div>
</form>

<script src="../../../component/layui/layui.js"></script>
<script src="../../../component/pear/pear.js"></script>
<script src="../../../config/common.js"></script>
<script src="../../../config/permission.js"></script>
<script src="../../../config/config.js"></script>
<script>

    const PRIMARY_KEY = "id";
    const READ_API = config.api_url + "/adminapi/wf/designer/detail";
    const SAVE_API = config.api_url + "/adminapi/wf/designer/save";
    const UPDATE_API = config.api_url + "/adminapi/wf/designer/update";
    const CATEGORY_API = config.api_url + "/adminapi/wf/category/page";

    // 字段设置
    layui.use(["common", "popup", "form", "jquery", "dtree"], function () {
        let popup = layui.popup;
        let form = layui.form;
        let method = 'POST';
        let Dtree = layui.dtree;
        let $ = layui.jquery;
        let superiorData = [];

        /**
         * 所属上级获取
         */
        layui.$.ajax({
            url: CATEGORY_API,
            type: 'GET',
            dataType: 'json',
            async: false,
            data: {page: 1, limit: 9999},
            success: function (ret) {
                let data = ret.data.list != undefined ? ret.data.list : [];
                superiorData = data;
            },
            error: function (ret) {
                superiorData = [];
            },
        });


        if (getQueryString('operation') == 'add') {
            Dtree.renderSelect({
                elem: "#designer-add-tree",
                data: superiorData,
                accordion: true,
                icon: "-1",  // 隐藏二级图标
                skin: "layui",
                width: '100%',
                selectCardHeight: "200",
                selectInitVal: '0',//默认值顶层
                response: {
                    treeId: "id", //节点ID（必填）
                    parentId: "pid", //父节点ID（必填）
                    title: "name", //节点名称（必填）
                },
                selectInputName: {
                    nodeId: "type_id",
                    context: "请选择父级"
                },
                done: function (res, $ul, first) {
                    if (first) {
                        //首次赋值顶层
                        Dtree.dataInit("designer-add-tree", '0');
                        Dtree.selectVal("designer-add-tree");
                    }
                }
            });
        }

        if (getQueryString('operation') == 'edit') {
            method = 'PUT'
            get()
            layui.$("button[type='reset']").click(function () {
                location.reload();
            })
            form.render()
        }


        /**
         * 表单提交
         */
        form.on("submit(designer-add-save)", function (data) {
            if (data.field['type_id'] == undefined || data.field['type_id'] == ''||data.field['type_id']=='0') {
                popup.failure('请选择流程类型');
                return false;
            }

            if (getQueryString('operation') == 'edit') {
                data.field[PRIMARY_KEY] = getQueryString(PRIMARY_KEY);
            }
            layui.$.ajax({
                url: getQueryString('operation') == 'add' ? SAVE_API : UPDATE_API,
                type: 'post',
                dateType: "json",
                contentType: 'application/json',
                data: JSON.stringify(data.field),
                success: function (ret) {
                    if (ret.status == 200) {
                        popup.success(ret.msg, function () {
                            parent.refreshTable();
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        });
                    } else {
                        popup.failure(ret.msg);
                    }
                }
            });
            return false;
        });

        function get() {
            layui.$.ajax({
                    url: READ_API,
                    method: 'GET',
                    dataType: 'JSON',
                    data: {id: getQueryString(PRIMARY_KEY)},
                    success: function (ret) {
                        if (ret.status === 200) {
                            let data = ret.data;
                            Dtree.renderSelect({
                                elem: "#designer-add-tree",
                                data: superiorData,
                                accordion: true,
                                icon: "-1",  // 隐藏二级图标
                                skin: "layui",
                                width: '100%',
                                selectCardHeight: "200",
                                selectInitVal: '0',//默认值顶层
                                response: {
                                    treeId: "id", //节点ID（必填）
                                    parentId: "pid", //父节点ID（必填）
                                    title: "name", //节点名称（必填）
                                },
                                selectInputName: {
                                    nodeId: "type_id",
                                    context: "请选择父级"
                                },
                                done: function (res, $ul, first) {
                                    //首次赋值顶层
                                    Dtree.dataInit("designer-add-tree", data['type_id']);
                                    Dtree.selectVal("designer-add-tree");
                                }
                            });

                            form.val("designer-add-form", data)
                            form.render();
                        }
                    },
                    error: function (ret) {
                        alert("出错" + ret.status + "：" + ret.responseText);
                    }
                }
            );
        }

        $("body").on("click", function (event) {
            $("div[dtree-id][dtree-select]").removeClass("layui-form-selected");
            $("div[dtree-id][dtree-card]").removeClass("dtree-select-show layui-anim layui-anim-upbit");
        });

    });


</script>

</body>
</html>
